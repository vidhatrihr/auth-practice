<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo App</title>
    <style>
      main {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      form {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      label {
        display: flex;
        justify-content: space-around;
        gap: 1rem;
      }
      .done {
        text-decoration: line-through;
        opacity: 0.6;
      }
    </style>
  </head>
  <body>
    <main>
      <!-- Login accordion -->
      <details>
        <summary>Login</summary>
        <form>
          <label>
            Email:
            <input type="text" id="email" value="rahul@example.com" />
          </label>

          <label>
            Password:
            <input type="text" id="password" value="qwerty" />
          </label>

          <button>Login</button>
        </form>
      </details>

      <div id="auth-result">not logged in</div>

      <button onclick="fetchTodos()">Fetch all todos</button>

      <ul id="todos"></ul>
    </main>

    <script>
      let sessionId = localStorage.getItem('sessionId');
      let token = localStorage.getItem('token');

      if (sessionId && token) {
        document.querySelector('#auth-result').textContent = 'already logged in';
      }

      document.querySelector('form').addEventListener('submit', handleLogin);

      const html = String.raw;

      async function handleLogin(event) {
        event.preventDefault();

        const response = await fetch('http://127.0.0.1:5000/auth/login', {
          method: 'post',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: document.querySelector('#email').value,
            password: document.querySelector('#password').value,
          }),
        });

        const data = await response.json();

        if (data.success) {
          console.log(data);
          sessionId = data.payload.session_id;
          token = data.payload.token;
          localStorage.setItem('sessionId', sessionId);
          localStorage.setItem('token', token);
        } else {
          console.error(data);
        }
        document.querySelector('#auth-result').textContent = data.message;
      }

      async function markDone(id) {
        const res = await fetch(
          `http://127.0.0.1:5000/todo/update?todo_id=${id}&action=mark_done&session_id=${sessionId}&token=${token}`
        );
        const data = await res.json();

        if (data.success) {
          console.log(data);
        } else {
          console.error(data);
        }
        data;
        fetchTodos();
      }

      async function fetchTodos() {
        const response = await fetch(
          `http://127.0.0.1:5000/todo/list?session_id=${sessionId}&token=${token}`
        );
        const data = await response.json();

        if (data.success) {
          console.log(data);
          todos = data.payload.todos;
        }

        renderTodos(data.payload.todos);
      }

      function renderTodos(todos) {
        console.log(todos[2].id);

        document.querySelector('#todos').innerHTML = '';
        for (let todo of todos) {
          console.log(todo);

          document.querySelector('#todos').insertAdjacentHTML(
            'beforeend',
            html`
              <li>
                <span class="${todo.is_done ? 'done' : 'empty'}" onclick="markDone(${todo.id})"
                  >${todo.text}</span
                >
              </li>
            `
          );
        }
      }
    </script>
  </body>
</html>
